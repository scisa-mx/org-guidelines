# Manejo de configuracion y secretos

## Configuración vs Secretos
Antes de hablar de herramientas, hay una regla fundamental:

### Configuración

Información que:

- Cambia por entorno
- No es sensible es tan sensible
- Puede vivir en texto plano

Ejemplos:
- URLs de servicios
- Feature flags
- Timeouts
- Nombres de servicios
- Puertos

### Secretos

Información que:
- Da acceso a sistemas
- Es sensible
- Nunca debe estar en repositorio

Ejemplos:
- Connection strings
- API Keys
- Passwords
- Tokens JWT
- Certificados


## Principios base
### Configuración por entorno, no por código
El código debe ser el mismo en todos los entornos. La configuración y secretos deben cambiar según el entorno (dev, staging, prod).

Mala practica:
```csharp
var apiUrl = "https://api.prod.scisa.com";
```

Mejor implementación:
```csharp
var apiUrl = configuration["Api:BaseUrl"];
```

### El mismo artefacto, múltiples entornos
En estos entornos solemos utilizar versionamiento e imagenes de docker en especifico. El mismo artefacto debe poder desplegarse en cualquier entorno sin cambios, cambiando solo la configuración y secretos.

- Mismo build
- Misma imagen Docker
- Diferente configuración

## .NET – appsettings.json y web.config

### Jerarquía oficial de configuración (.NET)

Orden recomendado:
- appsettings.json
- appsettings.{Environment}.json
- Variables de entorno
- Secret Manager / Vault (producción)

```csharp
new ConfigurationBuilder()
    .AddJsonFile("appsettings.json")
    .AddJsonFile($"appsettings.{environment}.json", optional: true)
    .AddEnvironmentVariables();
```
Esto ya lo aplican correctamente.

### Qué va en appsettings.json
- Configuración no sensible
- Valores por defecto
- URLs de servicios

```json
{
  "Api": {
    "BaseUrl": "https://api.scisa.com",
    "TimeoutSeconds": 30
  }
}
```

### Qué NO va en appsettings.json
- Secretos
- Connection strings (Considerando ambientes exteriores a tu control en development)
- API Keys

Mala practica:
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=prod.db.scisa.com;Database=main;User Id=admin;Password=SuperSecret123;"
  }
}
```

### web.config (legacy / ASP.NET MVC)

web.config solo para defaults
Secrets siempre vía variables de entorno

Ejemplo: 
```xml
<appSettings>
  <add key="FeatureXEnabled" value="true" />
</appSettings>
```

## Variables de entorno (estándar universal)
Las variables de entorno son el puente entre apps, Docker y Cloud.

### Convención de nombres
Preferentemente usar prefijos para evitar colisiones.
Primeramente el nombre de la aplicación o servicio, luego el nombre del secreto y por último el tipo de dato si aplica.

```text
SCISA_DB_CONNECTION=<value>
SCISA_JWT_SECRET=<value>
SCISA_API_BASE_URL=<value>
```

#### Convenciones en aplicaciones de Vue3
En vue las variables de entorno deben comenzar con `VITE_` para ser accesibles en el código. (se aplica esto junto con todos los lineamietos anteriores)

```text
VITE_API_BASE_URL=<value>
```

### Mapeo automático en .NET

Tenemos esto en nuestras variables
```text
Api__BaseUrl=https://api.scisa.com
Jwt__Secret=xxxxx
```

Se mapean automáticamente en .NET Core y podemos acceder así:
```csharp
configuration["Api:BaseUrl"];
configuration["Jwt:Secret"];
```

## Frontend – .env y config.js (Runtime Config)

Es usual pensar que un .env.production es seguro para secretos, pero no lo es. Todo lo que va al frontend es visible para el usuario final. 
Pero dependiendo de la situación, puede ser aceptable tener ciertos valores en el frontend, siempre y cuando no sean sensibles.

5.2 Variables en .env

Se permite:

```text
VITE_API_BASE_URL=https://api.scisa.com
VITE_ENVIRONMENT=production
```

Esta prohibido:

```
VITE_API_KEY=xxxxx
```

__estos valores deben ir en el backend__
__es posible utilizarlos como pruebas o test pero siempre considerando que no son seguros (rotación de claves)__

### Configuración en runtime (config.js)

Ejemplo recomendado:

```js
window.__APP_CONFIG__ = {
  API_BASE_URL: "__API_BASE_URL__",
  ENVIRONMENT: "__ENVIRONMENT__"
};
```

En Docker / Cloud Run:

```bash
envsubst < config.template.js > config.js
```

Esto permite:

Cambiar entorno sin rebuild
Usar misma imagen en dev / qa / prod

## Google Cloud Platform (GCP)

### Secret Manager (obligatorio en producción)

Uso recomendado:

- DB passwords
- API keys
- Certificados
- JWT secrets


### Consumo desde Cloud Run
Asignar secreto como variable:
```bash
DB_CONNECTION = projects/.../secrets/db-connection
API_KEY = projects/.../secrets/api-key
```

En .NET:
```csharp
configuration["DB_CONNECTION"];
configuration["API_KEY"];
```

### Configuración vs Secretos en GCP

| Tipo          | Dónde                |
| ------------- | -------------------- |
| Configuración | Variables de entorno |
| Secretos      | Secret Manager       |
| Feature flags | Env / Config Service |
| Certificados  | Secret Manager       |

## Anti-patrones comunes (prohibidos)
- Subir .env al repositorio
- Hardcodear URLs o passwords
- Compartir secretos por Slack o correo
- Reutilizar secretos entre entornos
- Logs que imprimen configuración sensible

