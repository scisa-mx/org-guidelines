# 4.4 Manejo de errores y excepciones

Para tu guía puedes estructurarlo como “Principios y Anti-patrones” en el manejo de errores y excepciones en .NET.

---

## 1. Principios básicos

### 1.1. Nunca atrapar una excepción si no vas a hacer nada útil

❌ Mal:

```csharp
try
{
    DoSomething();
}
catch (Exception)
{
    throw;
}
```

Eso no agrega valor: solo rompe el stacktrace lógico y ensucia el código.

✔️ Bien:

* O la dejas subir.
* O la manejas de verdad (log, traducir, compensar, fallback, etc.).

---

### 1.2. Loguear siempre cuando una excepción se maneja

Si la excepción **no se vuelve a lanzar**, debe quedar registrada.

```csharp
catch (SqlException ex)
{
    _logger.LogError(ex, "Error al guardar el cliente {ClientId}", clientId);
    return Result.Fail("No fue posible guardar el cliente");
}
```

Regla clara:

> Excepción atrapada y consumida = debe quedar en logs.

---

## 2. Re-lanzar correctamente

Si necesitas agregar contexto y volver a lanzar:

✔️ Correcto:

```csharp
catch (Exception ex)
{
    _logger.LogError(ex, "Error procesando orden {OrderId}", orderId);
    throw; // preserva stacktrace
}
```

❌ Incorrecto:

```csharp
catch (Exception ex)
{
    throw ex; // destruye el stacktrace original
}
```

---

## 3. Excepciones específicas, no genéricas

❌ Mal:

```csharp
catch (Exception ex)
```

✔️ Bien:

```csharp
catch (TimeoutException ex)
catch (UnauthorizedAccessException ex)
catch (SqlException ex)
```

Esto permite:

* Mensajes claros al usuario
* Decisiones distintas por tipo de fallo
* Mejor monitoreo

---

## 4. Traducir excepciones técnicas a errores de dominio

En capas de aplicación o API:

```csharp
catch (SqlException ex)
{
    throw new BusinessException("No se pudo registrar el pago", ex);
}
```

El dominio no debería conocer `SqlException`, `HttpRequestException`, etc.

---

## 5. Nunca ocultar excepciones silenciosamente

❌ Muy peligroso:

```csharp
catch (Exception)
{
    // nada
}
```

Esto genera:

* Errores fantasma
* Datos corruptos
* Bugs imposibles de rastrear

---

## 6. Centralizar el manejo

En APIs / Web:

* Middleware de excepciones global
* Filtros de excepción
* ProblemDetails

Para que:

* No se repita `try/catch` en todos lados
* El log sea consistente
* La respuesta al cliente sea estándar

---

## 7. Regla de oro para la guía

Puedes ponerla así:

> ### Buenas prácticas de manejo de excepciones
>
> * No atrapar excepciones si no se van a manejar.
> * Toda excepción consumida debe ser registrada en logs.
> * Nunca relanzar con `throw ex`, usar siempre `throw`.
> * Usar tipos de excepción específicos.
> * No usar excepciones como control de flujo.
> * Traducir excepciones técnicas a errores de dominio.
> * Evitar bloques `catch` vacíos.
> * Centralizar el manejo en middlewares o capas superiores.

Y como anti-patrón explícito:

> ❌ **Anti-patrón:** “Atrapar para que no truene”
>
> Capturar excepciones solo para evitar que la aplicación falle, sin log, sin contexto y sin corrección, genera sistemas frágiles, difíciles de depurar y propensos a corrupción de datos.
