# Lineamientos de performance y revisión de consultas

El performance no es un “nice to have”. En sistemas productivos, el rendimiento impacta directamente en costos, estabilidad, experiencia de usuario y capacidad de escalar.  
Una mala consulta puede degradar todo un sistema, incluso cuando el resto del código está bien diseñado.

Por eso, el performance debe tratarse como **parte del estándar de calidad del codebase**, no como una optimización tardía.

## Performance como responsabilidad compartida

El rendimiento no es responsabilidad exclusiva del DBA ni del equipo de infraestructura.  
Desde una perspectiva moderna (Clean Architecture y DevOps), el performance es responsabilidad de:

- Quien diseña el modelo de datos
- Quien escribe la consulta
- Quien revisa el PR
- Quien define los límites del dominio
- Quien mantiene los pipelines y monitoreo

Ignorar el performance en revisiones de código es **aceptar deuda técnica de alto impacto**.

## Principios base para consultas eficientes

Antes de optimizar, hay principios que deben cumplirse siempre.

Una consulta debe:
- Resolver un caso de uso concreto
- Traer solo los datos necesarios
- Ejecutarse de forma predecible
- Escalar con el crecimiento de datos
- Ser comprensible y mantenible

Si una consulta no cumple esto, debe revisarse antes de llegar a producción.

## Evitar traer más datos de los necesarios

Uno de los problemas más comunes es **sobreconsultar**.

Ejemplos problemáticos:
- Uso de `SELECT *`
- Cargar entidades completas cuando solo se necesitan pocos campos
- Incluir relaciones innecesarias

Esto genera:
- Mayor uso de memoria
- Mayor tiempo de red
- Mayor carga en base de datos

Buenas prácticas:
- Seleccionar solo columnas necesarias
- Proyectar a DTOs
- Evitar materializar entidades completas sin necesidad

## Revisión de consultas en Pull Requests

Las consultas deben revisarse con el mismo rigor que la lógica de negocio.

Durante una revisión, se debe evaluar:
- Qué datos se están trayendo
- Cuántas filas potencialmente retorna
- Si existen filtros adecuados
- Si se usan índices existentes
- Si el patrón de acceso es correcto

Un PR que agrega una consulta nueva **no debe aprobarse** sin este análisis.

## Cuidado con consultas dentro de loops

Un antipatrón clásico es ejecutar consultas dentro de iteraciones.

Problemas típicos:
- N+1 queries
- Multiplicación del costo por volumen de datos
- Dificultad para detectar el problema en ambientes pequeños

Buenas prácticas:
- Consolidar consultas
- Usar joins cuando sea apropiado
- Cargar datos en bloques
- Medir antes de asumir

Este tipo de problemas deben detectarse en revisión, no en producción.

## Paginación y límites

Cualquier endpoint o proceso que pueda devolver múltiples registros debe:
- Implementar paginación
- Definir límites razonables
- Evitar cargas masivas por defecto

Endpoints sin paginación son una bomba de tiempo cuando el volumen crece.

## Índices y filtros

Una consulta sin filtros adecuados o sin índices relevantes:
- Escala mal
- Consume recursos excesivos
- Afecta a otros procesos

Lineamientos:
- Toda consulta frecuente debe tener un índice asociado
- Filtros por columnas indexadas
- Evitar funciones en columnas indexadas cuando sea posible
- Revisar planes de ejecución en consultas críticas

## ORM no es excusa

El uso de ORMs no elimina la responsabilidad sobre el performance.

Problemas comunes con ORMs:
- Queries generadas sin control
- Carga automática de relaciones
- Falta de proyecciones
- Materialización innecesaria

Buenas prácticas:
- Conocer el SQL que se genera
- Usar proyecciones explícitas
- Desactivar cargas automáticas no necesarias
- Medir consultas generadas

## Performance y pruebas

El performance también se valida.

Prácticas recomendadas:
- Probar consultas con volúmenes representativos
- Validar tiempos de respuesta
- Incluir métricas en entornos de prueba
- Simular escenarios reales

No basta con que “funcione”; debe **funcionar bien bajo carga**.

## Monitoreo y feedback

El performance no termina en el merge.

Se debe:
- Monitorear consultas lentas
- Revisar métricas en producción
- Detectar regresiones
- Retroalimentar al equipo

Los problemas detectados deben convertirse en mejoras del estándar.

## Buenas prácticas

- Revisar consultas en PR
- Evitar `SELECT *`
- Proyectar a DTOs
- Implementar paginación
- Revisar índices
- Evitar N+1 queries
- Medir consultas críticas
- Conocer el SQL generado por ORMs

## Do’s & Don’ts

### Do
- Diseñar consultas por caso de uso
- Traer solo lo necesario
- Revisar impacto de cada query
- Usar paginación por defecto
- Monitorear en producción
- Detectar problemas en revisión

### Don’t
- Asumir que “la BD lo aguanta”
- Cargar entidades completas sin necesidad
- Ejecutar queries en loops
- Aprobar PRs sin revisar consultas
- Optimizar a ciegas
- Ignorar métricas reales
